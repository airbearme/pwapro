name: ðŸ” Sync Secrets & Environment Variables

on:
  workflow_dispatch:
    inputs:
      sync_to_vercel:
        description: 'Sync secrets to Vercel'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
  schedule:
    # Run daily at 2 AM UTC to verify secrets are synced
    - cron: '0 2 * * *'

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  sync-to-vercel:
    name: Sync Secrets to Vercel
    runs-on: ubuntu-latest
    if: github.event.inputs.sync_to_vercel != 'false'
    steps:
      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Login to Vercel
        run: |
          echo "${{ secrets.VERCEL_TOKEN }}" | vercel login --token-stdin

      - name: Verify Vercel project
        run: |
          vercel project ls --token="${{ secrets.VERCEL_TOKEN }}"

      - name: Sync Supabase variables
        run: |
          echo "Syncing Supabase environment variables..."
          
          # Add or update Supabase URL
          echo "${{ secrets.NEXT_PUBLIC_SUPABASE_PWA4_URL }}" | \
            vercel env add NEXT_PUBLIC_SUPABASE_PWA4_URL production --token="${{ secrets.VERCEL_TOKEN }}" || \
            vercel env rm NEXT_PUBLIC_SUPABASE_PWA4_URL production --yes --token="${{ secrets.VERCEL_TOKEN }}" && \
            echo "${{ secrets.NEXT_PUBLIC_SUPABASE_PWA4_URL }}" | \
            vercel env add NEXT_PUBLIC_SUPABASE_PWA4_URL production --token="${{ secrets.VERCEL_TOKEN }}"
          
          # Add or update Supabase Anon Key
          echo "${{ secrets.NEXT_PUBLIC_SUPABASE_PWA4_ANON_KEY }}" | \
            vercel env add NEXT_PUBLIC_SUPABASE_PWA4_ANON_KEY production --token="${{ secrets.VERCEL_TOKEN }}" || \
            vercel env rm NEXT_PUBLIC_SUPABASE_PWA4_ANON_KEY production --yes --token="${{ secrets.VERCEL_TOKEN }}" && \
            echo "${{ secrets.NEXT_PUBLIC_SUPABASE_PWA4_ANON_KEY }}" | \
            vercel env add NEXT_PUBLIC_SUPABASE_PWA4_ANON_KEY production --token="${{ secrets.VERCEL_TOKEN }}"
          
          # Add or update Service Role Key
          echo "${{ secrets.SUPABASE_PWA4_SERVICE_ROLE_KEY }}" | \
            vercel env add SUPABASE_PWA4_SERVICE_ROLE_KEY production --token="${{ secrets.VERCEL_TOKEN }}" || \
            vercel env rm SUPABASE_PWA4_SERVICE_ROLE_KEY production --yes --token="${{ secrets.VERCEL_TOKEN }}" && \
            echo "${{ secrets.SUPABASE_PWA4_SERVICE_ROLE_KEY }}" | \
            vercel env add SUPABASE_PWA4_SERVICE_ROLE_KEY production --token="${{ secrets.VERCEL_TOKEN }}"

      - name: Sync Stripe variables
        run: |
          echo "Syncing Stripe environment variables..."
          
          echo "${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}" | \
            vercel env add NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY production --token="${{ secrets.VERCEL_TOKEN }}" || \
            vercel env rm NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY production --yes --token="${{ secrets.VERCEL_TOKEN }}" && \
            echo "${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}" | \
            vercel env add NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY production --token="${{ secrets.VERCEL_TOKEN }}"
          
          echo "${{ secrets.STRIPE_SECRET_KEY }}" | \
            vercel env add STRIPE_SECRET_KEY production --token="${{ secrets.VERCEL_TOKEN }}" || \
            vercel env rm STRIPE_SECRET_KEY production --yes --token="${{ secrets.VERCEL_TOKEN }}" && \
            echo "${{ secrets.STRIPE_SECRET_KEY }}" | \
            vercel env add STRIPE_SECRET_KEY production --token="${{ secrets.VERCEL_TOKEN }}"
          
          echo "${{ secrets.STRIPE_WEBHOOK_SECRET }}" | \
            vercel env add STRIPE_WEBHOOK_SECRET production --token="${{ secrets.VERCEL_TOKEN }}" || \
            vercel env rm STRIPE_WEBHOOK_SECRET production --yes --token="${{ secrets.VERCEL_TOKEN }}" && \
            echo "${{ secrets.STRIPE_WEBHOOK_SECRET }}" | \
            vercel env add STRIPE_WEBHOOK_SECRET production --token="${{ secrets.VERCEL_TOKEN }}"

      - name: Sync site configuration
        run: |
          echo "Syncing site configuration..."
          
          echo "${{ secrets.NEXT_PUBLIC_SITE_URL || 'https://airbear.me' }}" | \
            vercel env add NEXT_PUBLIC_SITE_URL production --token="${{ secrets.VERCEL_TOKEN }}" || \
            vercel env rm NEXT_PUBLIC_SITE_URL production --yes --token="${{ secrets.VERCEL_TOKEN }}" && \
            echo "${{ secrets.NEXT_PUBLIC_SITE_URL || 'https://airbear.me' }}" | \
            vercel env add NEXT_PUBLIC_SITE_URL production --token="${{ secrets.VERCEL_TOKEN }}"

      - name: Verify synced variables
        run: |
          echo "Verifying environment variables in Vercel..."
          vercel env ls production --token="${{ secrets.VERCEL_TOKEN }}"

      - name: Summary
        run: |
          echo "## âœ… Secrets Synced Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All environment variables have been synced to Vercel production environment." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Synced variables:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… NEXT_PUBLIC_SUPABASE_PWA4_URL" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… NEXT_PUBLIC_SUPABASE_PWA4_ANON_KEY" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SUPABASE_PWA4_SERVICE_ROLE_KEY" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… STRIPE_SECRET_KEY" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… STRIPE_WEBHOOK_SECRET" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… NEXT_PUBLIC_SITE_URL" >> $GITHUB_STEP_SUMMARY

